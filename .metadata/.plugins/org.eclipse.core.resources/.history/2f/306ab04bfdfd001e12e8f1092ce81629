package gestion;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.util.ArrayList;
import java.util.List;

import data.Logins;
import data.Yapes;
import interfaces.IntYape;
import util.MysqlConexion;

public class Metodos implements IntYape {

	public Logins Login(int numero, String clave, String tipoUsr) {
		Connection con = null;
		PreparedStatement psm = null;
		ResultSet rs = null;
		Logins loginData = new Logins();
		try {
			String sql = "SELECT TipoUsuario, Numero, Clave, NombreApellidos FROM logins WHERE Numero=? AND Clave=? AND TipoUsuario=?;";
			con = MysqlConexion.getConexion();
			psm = con.prepareStatement(sql);
			psm.setInt(1, numero);
			psm.setString(2, clave);
			psm.setString(3, tipoUsr);
			rs = psm.executeQuery();
			rs.next();
			if(rs.getInt("Numero") != numero) return null;
			if(!rs.getString("Clave").equals(clave)) return null;
			if (!rs.getString("TipoUsuario").equals(tipoUsr)) return null;
			loginData.setNumero(rs.getInt("numero"));
			loginData.setClave(rs.getString("clave"));
			loginData.setTipoUsuario(rs.getString("TipoUsuario"));
			loginData.setNombreApellidos(rs.getString("NombreApellidos"));
			
			//Set Current Login Data
			
			sql = "INSERT INTO CurrentUsers (Numero, NombreApellidos) VALUES(?,?)";
			psm = con.prepareStatement(sql);
			psm.setInt(1, rs.getInt("numero"));
			psm.setString(2, rs.getString("NombreApellidos"));
			psm.executeUpdate();
			
			return loginData;
		} catch(Exception e) {
			System.out.println("Error en el bloque Try Catch de Metodos-Login");
		}
		return null;
	}
	
	public int obtenerUusario() {
		Connection con = null;
		PreparedStatement psm = null;
		int numero = 0;
		ResultSet rs = null;
		try {
			con = MysqlConexion.getConexion();
			String sql = "Select numero from currentUsers;";
			psm = con.prepareStatement(sql);
			rs = psm.executeQuery();
			rs.next();
			numero = rs.getInt("numero");
			return numero;
		}catch(Exception e) {
			System.out.println("No se pudo Obtener el Usuario/No Existe");
		}
		return numero;
	}
	
	public List<Yapes> ListarYapes() {
		Connection con = null;
		PreparedStatement psm = null;
		ResultSet rs = null;
		List<Yapes> yapeList = new ArrayList<Yapes>();
		try {
			con = MysqlConexion.getConexion();
			String sql = "SELECT * FROM Yapes WHERE NumeroRealizante=? OR NumeroRecibiente=?;";
			psm = con.prepareStatement(sql);
			psm.setInt(1, obtenerUusario());
			psm.setInt(2, obtenerUusario());
			rs = psm.executeQuery();
			while(rs.next()) {
				Yapes yape = new Yapes();
				yape.setIdYape(rs.getInt("IdYape"));
				yape.setNumeroRealizante(rs.getInt("NumeroRealizante"));
				yape.setNumeroRecibiente(rs.getInt("NumeroRecibiente"));
				yape.setMonto(rs.getDouble("Monto"));
				yape.setFecha(rs.getString("Fecha"));
				yape.setHora(rs.getString("Hora"));
				yapeList.add(yape);
			}
		} catch(Exception e) {
			System.out.println("Error en el Try Catch de Metodos-Listar");
		}
		return yapeList;
	}
	
	public Yapes formatearFecha(String Fecha) {
		Yapes fecha = new Yapes();
		Connection con = null;
		PreparedStatement psm = null;
		ResultSet rs = null;
		try {
			String sql = "SELECT DATE_FORMAT(?,'%W %M %e %Y') AS FechaFormateada";
			con = MysqlConexion.getConexion();
			psm = con.prepareStatement(sql);
			psm.setString(1, Fecha);
			rs = psm.executeQuery();
			rs.next();
		} catch(Exception e) {
			
		}
		return fecha;
	}

	public void cerrarSesion() {
		Connection con = null;
		PreparedStatement psm = null;
		try {
			con = MysqlConexion.getConexion();
			String sql = "Delete from currentUsers;";
			psm = con.prepareStatement(sql);
			psm.executeUpdate();
		} catch(Exception e) {
			System.out.println("Error En el Bloque Try Catch Cerrar Sesion");
		}
	}
	
}
